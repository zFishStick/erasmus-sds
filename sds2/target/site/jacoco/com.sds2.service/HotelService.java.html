<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HotelService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sds2</a> &gt; <a href="index.source.html" class="el_package">com.sds2.service</a> &gt; <span class="el_source">HotelService.java</span></div><h1>HotelService.java</h1><pre class="source lang-java linenums">package com.sds2.service;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.List;
import java.util.Locale;
import java.util.logging.Logger;

import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import com.sds2.classes.Price;
import com.sds2.classes.coordinates.GeoCode;
import com.sds2.classes.entity.Hotel;
import com.sds2.classes.hotel.HotelAddress;
import com.sds2.classes.response.HotelResponse;
import com.sds2.dto.HotelDTO;
import com.sds2.dto.HotelDetailsDTO;
import com.sds2.dto.HotelOfferDTO;
import com.sds2.repository.HotelRepository;

@Service
public class HotelService {
    private final HotelRepository hotelRepository;
    private final HotelOfferService hotelOfferService;
    private final AmadeusAuthService amadeusAuthService;
    private final WebClient.Builder webClientBuilder;

    public HotelService(
            AmadeusAuthService amadeusAuthService,
            HotelOfferService hotelOfferService,
            HotelRepository hotelRepository,
            WebClient.Builder webClientBuilder
<span class="fc" id="L34">    ) {</span>
<span class="fc" id="L35">        this.amadeusAuthService = amadeusAuthService;</span>
<span class="fc" id="L36">        this.hotelOfferService = hotelOfferService;</span>
<span class="fc" id="L37">        this.hotelRepository = hotelRepository;</span>
<span class="fc" id="L38">        this.webClientBuilder = webClientBuilder;</span>
<span class="fc" id="L39">    }</span>

    public void addHotel(Hotel hotel) {
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (hotel == null) {</span>
<span class="fc" id="L43">            throw new IllegalArgumentException(&quot;Hotel cannot be null&quot;);</span>
        }

<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (hotel.getHotelId() != null) {</span>
<span class="fc" id="L47">            Hotel existing = hotelRepository.findByHotelId(hotel.getHotelId());</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">            if (existing != null) {</span>
<span class="fc" id="L49">                return;</span>
            }
        }

<span class="fc" id="L53">        hotelRepository.save(hotel);</span>
<span class="fc" id="L54">    }</span>

    public List&lt;HotelDetailsDTO&gt; getHotelById(String hotelId, int adults, String checkInDate, String checkOutDate) {
<span class="fc" id="L57">        Hotel hotel = hotelRepository.findByHotelId(hotelId);</span>

<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (hotel == null) {</span>
<span class="fc" id="L60">            return List.of();</span>
        }

<span class="fc" id="L63">        List&lt;HotelOfferDTO&gt; offers = hotelOfferService.getOffersByHotelId(hotelId, adults, checkInDate, checkOutDate);</span>

<span class="fc" id="L65">        HotelDTO hotelDTO = mapToDTO(hotel);</span>

<span class="fc" id="L67">        List&lt;HotelDetailsDTO&gt; details = offers.stream()</span>
<span class="fc" id="L68">                .map(offer -&gt; new HotelDetailsDTO(hotelDTO.withOffer(offer), offer))</span>
<span class="fc" id="L69">                .toList();</span>

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (details.isEmpty()) {</span>
<span class="nc" id="L72">            return List.of(new HotelDetailsDTO(hotelDTO, null));</span>
        }

<span class="fc" id="L75">        return details;</span>
    }

    public Price getLowestPriceForHotel(String hotelId, int adults, String checkInDate, String checkOutDate) {
<span class="fc" id="L79">        List&lt;HotelOfferDTO&gt; offers = hotelOfferService.getOffersByHotelId(hotelId, adults, checkInDate, checkOutDate);</span>
<span class="fc" id="L80">        return offers.stream()</span>
<span class="fc" id="L81">                .map(HotelOfferDTO::price)</span>
<span class="pc bpc" id="L82" title="2 of 4 branches missed.">                .filter(price -&gt; price != null &amp;&amp; price.getAmount() &gt; 0)</span>
<span class="fc" id="L83">                .min((p1, p2) -&gt; Double.compare(p1.getAmount(), p2.getAmount()))</span>
<span class="fc" id="L84">                .orElse(null);</span>
    }

    public List&lt;HotelDTO&gt; getHotelsByCoordinates(Double latitude, Double longitude, String cityName, String countryCode) {

<span class="fc" id="L89">        List&lt;Hotel&gt; hotels = List.of();</span>

<span class="fc" id="L91">        String normalizedCity = normalize(cityName);</span>
<span class="fc" id="L92">        String normalizedCountry = normalize(countryCode);</span>

<span class="pc bpc" id="L94" title="2 of 4 branches missed.">        if (normalizedCity != null &amp;&amp; normalizedCountry != null) {</span>
<span class="fc" id="L95">            hotels = hotelRepository.findByAddress_CityNameIgnoreCaseAndAddress_CountryCodeIgnoreCase(normalizedCity, normalizedCountry);</span>
        }

<span class="pc bpc" id="L98" title="1 of 4 branches missed.">        if (hotels.isEmpty() &amp;&amp; normalizedCity != null) {</span>
<span class="fc" id="L99">            hotels = hotelRepository.findByAddress_CityNameIgnoreCase(normalizedCity);</span>
        }

<span class="pc bpc" id="L102" title="1 of 4 branches missed.">        if (hotels.isEmpty() &amp;&amp; normalizedCountry != null) {</span>
<span class="fc" id="L103">            hotels = hotelRepository.findByAddress_CountryCodeIgnoreCase(normalizedCountry);</span>
        }

<span class="pc bpc" id="L106" title="2 of 6 branches missed.">        if (hotels.isEmpty() &amp;&amp; latitude != null &amp;&amp; longitude != null) {</span>
<span class="fc" id="L107">            hotels = hotelRepository.findByCoordinates_LatitudeAndCoordinates_Longitude(latitude, longitude);</span>
        }

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (!hotels.isEmpty()) {</span>
<span class="fc" id="L111">            return hotels.stream()</span>
<span class="fc" id="L112">                    .map(this::mapToDTO)</span>
<span class="fc" id="L113">                    .toList();</span>
        }

<span class="fc" id="L116">        Logger.getLogger(HotelService.class.getName()).info(&quot;No hotels found in database for given destination.&quot;);</span>

<span class="fc" id="L118">        return getHotelsByCoordinatesFromAPI(latitude, longitude, normalizedCity, normalizedCountry);</span>

    }

    private List&lt;HotelDTO&gt; getHotelsByCoordinatesFromAPI(Double latitude, Double longitude, String cityName, String countryCode) {

<span class="fc" id="L124">        String url = String.format(Locale.US,</span>
                &quot;https://api.amadeus.com/v1/reference-data/locations/hotels/by-geocode?latitude=%f&amp;longitude=%f&amp;radius=2&quot;, latitude, longitude);

        URI uri;
        try {
<span class="fc" id="L129">            uri = new URI(url);</span>
<span class="nc" id="L130">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L131">            Logger.getLogger(HotelService.class.getName()).severe(&quot;Invalid URI syntax: &quot; + e.getMessage());</span>
<span class="nc" id="L132">            return List.of();</span>
<span class="fc" id="L133">        }</span>

<span class="fc" id="L135">        HotelResponse response = webClientBuilder</span>
<span class="fc" id="L136">                .build()</span>
<span class="fc" id="L137">                .get()</span>
<span class="fc" id="L138">                .uri(uri)</span>
<span class="fc" id="L139">                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + amadeusAuthService.getAccessToken())</span>
<span class="fc" id="L140">                .retrieve()</span>
<span class="fc" id="L141">                .bodyToMono(HotelResponse.class)</span>
<span class="fc" id="L142">                .block();</span>

<span class="pc bpc" id="L144" title="2 of 4 branches missed.">        if (response == null || response.getData() == null) {</span>
<span class="nc" id="L145">            throw new IllegalStateException(&quot;Failed to retrieve hotels from API: response data is null&quot;);</span>
        }

<span class="fc" id="L148">        return mapToDTOs(response, latitude, longitude, cityName, countryCode);</span>
    }

    private List&lt;HotelDTO&gt; mapToDTOs(HotelResponse response, Double defaultLat, Double defaultLon, String defaultCity, String defaultCountry) {
<span class="fc" id="L152">        return response.getData().stream()</span>
<span class="fc" id="L153">                .map(data -&gt; {</span>
<span class="fc" id="L154">                    GeoCode geoCode = resolveCoordinates(data, defaultLat, defaultLon);</span>
<span class="fc" id="L155">                    HotelAddress address = mapHotelAddress(data.getAddress(), defaultCity, defaultCountry);</span>
<span class="fc" id="L156">                    Hotel hotel = new Hotel(</span>
<span class="fc" id="L157">                            data.getHotelId(),</span>
<span class="fc" id="L158">                            data.getName(),</span>
<span class="fc" id="L159">                            data.getIataCode(),</span>
                            address,
                            geoCode
                    );
<span class="fc" id="L163">                    addHotel(hotel);</span>
<span class="fc" id="L164">                    return mapToDTO(hotel);</span>
                })
<span class="fc" id="L166">                .toList();</span>
    }

    private HotelDTO mapToDTO(Hotel hotel) {

<span class="fc" id="L171">        return new HotelDTO(</span>
<span class="fc" id="L172">                hotel.getHotelId(),</span>
<span class="fc" id="L173">                hotel.getName(),</span>
<span class="fc" id="L174">                hotel.getCoordinates(),</span>
<span class="fc" id="L175">                hotel.getAddress(),</span>
<span class="fc" id="L176">                List.of()</span>
        );
    }

    private GeoCode resolveCoordinates(HotelResponse.HotelData data, Double defaultLat, Double defaultLon) {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (data.getGeoCode() != null) {</span>
<span class="nc" id="L182">            return data.getGeoCode();</span>
        }

<span class="fc" id="L185">        GeoCode enriched = fetchHotelCoordinates(data.getHotelId());</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (enriched != null) {</span>
<span class="nc" id="L187">            return enriched;</span>
        }

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        double lat = defaultLat != null ? defaultLat : 0;</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        double lon = defaultLon != null ? defaultLon : 0;</span>
<span class="fc" id="L192">        return new GeoCode(lat, lon);</span>
    }

    private GeoCode fetchHotelCoordinates(String hotelId) {
<span class="pc bpc" id="L196" title="2 of 4 branches missed.">        if (hotelId == null || hotelId.isBlank()) {</span>
<span class="nc" id="L197">            return null;</span>
        }

<span class="fc" id="L200">        String url = String.format(</span>
            &quot;https://api.amadeus.com/v1/reference-data/locations/hotels/%s&quot;, hotelId);

        try {
<span class="fc" id="L204">            HotelDetailResponse response = webClientBuilder</span>
<span class="fc" id="L205">                    .build()</span>
<span class="fc" id="L206">                    .get()</span>
<span class="fc" id="L207">                    .uri(url)</span>
<span class="nc" id="L208">                    .header(&quot;Authorization&quot;, &quot;Bearer &quot; + amadeusAuthService.getAccessToken())</span>
<span class="nc" id="L209">                    .retrieve()</span>
<span class="nc" id="L210">                    .bodyToMono(HotelDetailResponse.class)</span>
<span class="nc" id="L211">                    .block();</span>
<span class="nc bnc" id="L212" title="All 4 branches missed.">            if (response != null &amp;&amp; response.data != null) {</span>
<span class="nc" id="L213">                GeoCode code = response.data.getGeoCode();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (code != null) {</span>
<span class="nc" id="L215">                    return code;</span>
                }
            }
<span class="fc" id="L218">        } catch (Exception ex) {</span>
<span class="fc" id="L219">            Logger.getLogger(HotelService.class.getName())</span>
<span class="fc" id="L220">                    .warning(&quot;Unable to enrich coordinates for hotel &quot; + hotelId + &quot;: &quot; + ex.getMessage());</span>
<span class="nc" id="L221">        }</span>
<span class="fc" id="L222">        return null;</span>
    }

    private HotelAddress mapHotelAddress(HotelResponse.Address source, String defaultCity, String defaultCountry) {
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        if (source == null) {</span>
<span class="fc" id="L227">            return new HotelAddress(null, defaultCity, defaultCountry);</span>
        }
<span class="nc" id="L229">        String firstLine = null;</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">        if (source.getLines() != null &amp;&amp; !source.getLines().isEmpty()) {</span>
<span class="nc" id="L231">            firstLine = source.getLines().get(0);</span>
        }
<span class="nc" id="L233">        return new HotelAddress(</span>
                firstLine,
<span class="nc bnc" id="L235" title="All 2 branches missed.">                normalize(source.getCityName() != null ? source.getCityName() : defaultCity),</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                normalize(source.getCountryCode() != null ? source.getCountryCode() : defaultCountry)</span>
        );
    }

    private String normalize(String value) {
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        return value != null ? value.trim() : null;</span>
    }

    private static class HotelDetailResponse {
        private HotelResponse.HotelData data;
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>