<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HotelController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sds2</a> &gt; <a href="index.source.html" class="el_package">com.sds2.controller</a> &gt; <span class="el_source">HotelController.java</span></div><h1>HotelController.java</h1><pre class="source lang-java linenums">package com.sds2.controller;

import java.util.List;
import java.util.Objects;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.sds2.classes.enums.HotelEnum;
import com.sds2.classes.hotel.HotelSearchContext;
import com.sds2.classes.request.HotelRequest;
import com.sds2.dto.HotelDTO;
import com.sds2.dto.HotelDetailsDTO;
import com.sds2.dto.HotelOfferDTO;
import com.sds2.service.HotelAvailabilityService;
import com.sds2.service.HotelService;
import com.sds2.util.Pagination;

import jakarta.servlet.http.HttpSession;
import org.springframework.web.bind.annotation.GetMapping;


@Controller
@RequestMapping(&quot;/hotels&quot;)
public class HotelController {

    private static final int DEFAULT_PAGE_SIZE = 9;

    private final HotelService hotelService;
    private final HotelAvailabilityService availabilityService;

<span class="fc" id="L35">    public HotelController(HotelService hotelService, HotelAvailabilityService availabilityService) {</span>
<span class="fc" id="L36">        this.hotelService = hotelService;</span>
<span class="fc" id="L37">        this.availabilityService = availabilityService;</span>
<span class="fc" id="L38">    }</span>

    @PostMapping
    public String searchHotels (
        HotelRequest hotelRequest,
        Model model,
        HttpSession session
    ) {
<span class="pc bpc" id="L46" title="2 of 4 branches missed.">        if (hotelRequest.getLatitude() == null || hotelRequest.getLongitude() == null) {</span>
<span class="nc" id="L47">            return &quot;error&quot;;</span>
        }

<span class="fc" id="L50">        List&lt;HotelDTO&gt; hotels = hotelService.getHotelsByCoordinates(</span>
<span class="fc" id="L51">            hotelRequest.getLatitude(),</span>
<span class="fc" id="L52">            hotelRequest.getLongitude(),</span>
<span class="fc" id="L53">            hotelRequest.getDestination(),</span>
<span class="fc" id="L54">            hotelRequest.getCountryCode()</span>
        );
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if (hotels == null) {</span>
<span class="nc" id="L57">            hotels = List.of();</span>
        }

<span class="fc" id="L60">        HotelSearchContext context = new HotelSearchContext(</span>
<span class="fc" id="L61">            hotelRequest.getDestination(),</span>
<span class="fc" id="L62">            hotelRequest.getCountryCode(),</span>
<span class="fc" id="L63">            hotelRequest.getLatitude(),</span>
<span class="fc" id="L64">            hotelRequest.getLongitude(),</span>
<span class="fc" id="L65">            hotelRequest.getCheckInDate(),</span>
<span class="fc" id="L66">            hotelRequest.getCheckOutDate(),</span>
<span class="fc" id="L67">            normalizePageSize(DEFAULT_PAGE_SIZE)</span>
        );

<span class="fc" id="L70">        session.setAttribute(HotelEnum.HOTELS_DATA.getValue(), hotels);</span>
<span class="fc" id="L71">        session.setAttribute(HotelEnum.SEARCH_CONTEXT.getValue(), context);</span>

<span class="fc" id="L73">        int resolvedPage = populateHotelsModel(model, hotels, 0, context);</span>
<span class="fc" id="L74">        session.setAttribute(HotelEnum.CURRENT_PAGE.getValue(), resolvedPage);</span>
<span class="fc" id="L75">        return &quot;redirect:/hotels&quot;;</span>
    }

    @GetMapping
    public String restoreHotelsFromSession(
        @RequestParam(value = &quot;page&quot;, defaultValue = &quot;0&quot;) int page,
        Model model,
        HttpSession session
    ) {
<span class="nc" id="L84">        List&lt;HotelDTO&gt; hotels =</span>
<span class="nc" id="L85">            (List&lt;HotelDTO&gt;) session.getAttribute(HotelEnum.HOTELS_DATA.getValue());</span>

<span class="nc" id="L87">        HotelSearchContext context =</span>
<span class="nc" id="L88">            (HotelSearchContext) session.getAttribute(HotelEnum.SEARCH_CONTEXT.getValue());</span>

<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (hotels == null || context == null) {</span>
<span class="nc" id="L91">            return &quot;redirect:/&quot;;</span>
        }

<span class="nc" id="L94">        int resolvedPage = populateHotelsModel(model, hotels, page, context);</span>
<span class="nc" id="L95">        session.setAttribute(HotelEnum.CURRENT_PAGE.getValue(), resolvedPage);</span>

<span class="nc" id="L97">        return HotelEnum.HOTELS_DATA.getValue();</span>
    }
    

    @PostMapping(&quot;/page&quot;)
    public String changePage (
        @RequestParam(&quot;page&quot;) int requestedPage,
        @RequestParam(value = &quot;size&quot;, required = false) Integer size,
        Model model,
        HttpSession session
    ) {
<span class="fc" id="L108">        List&lt;HotelDTO&gt; hotels = getHotelsFromSession(session);</span>
<span class="fc" id="L109">        HotelSearchContext context = (HotelSearchContext) session.getAttribute(HotelEnum.SEARCH_CONTEXT.getValue());</span>

<span class="pc bpc" id="L111" title="2 of 4 branches missed.">        if (hotels == null || context == null) {</span>
<span class="nc" id="L112">            return &quot;error&quot;;</span>
        }

<span class="fc" id="L115">        HotelSearchContext effectiveContext = context;</span>
<span class="pc bpc" id="L116" title="3 of 6 branches missed.">        if (size != null &amp;&amp; size &gt; 0 &amp;&amp; size != context.pageSize()) {</span>
<span class="fc" id="L117">            effectiveContext = context.withPageSize(normalizePageSize(size));</span>
<span class="fc" id="L118">            session.setAttribute(HotelEnum.SEARCH_CONTEXT.getValue(), effectiveContext);</span>
        }

<span class="fc" id="L121">        int resolvedPage = populateHotelsModel(model, hotels, requestedPage, effectiveContext);</span>
<span class="fc" id="L122">        session.setAttribute(HotelEnum.CURRENT_PAGE.getValue(), resolvedPage);</span>
<span class="fc" id="L123">        return HotelEnum.HOTELS_DATA.getValue();</span>
    }

    @PostMapping(&quot;/details&quot;)
    public String showHotelDetails(
        @RequestParam(&quot;hotelId&quot;) String hotelId,
        @RequestParam(value = &quot;adults&quot;, defaultValue = &quot;1&quot;) int adults,
        @RequestParam(value = &quot;checkInDate&quot;, required = false) String checkInDate,
        @RequestParam(value = &quot;checkOutDate&quot;, required = false) String checkOutDate,
        Model model,
        HttpSession session
    ) {
<span class="fc" id="L135">        HotelSearchContext context = (HotelSearchContext) session.getAttribute(HotelEnum.SEARCH_CONTEXT.getValue());</span>

<span class="fc" id="L137">        String effectiveCheckIn = checkInDate;</span>
<span class="fc" id="L138">        String effectiveCheckOut = checkOutDate;</span>

<span class="pc bpc" id="L140" title="4 of 6 branches missed.">        if ((effectiveCheckIn == null || effectiveCheckIn.isBlank()) &amp;&amp; context != null) {</span>
<span class="nc" id="L141">            effectiveCheckIn = context.checkInDate();</span>
        }
<span class="pc bpc" id="L143" title="4 of 6 branches missed.">        if ((effectiveCheckOut == null || effectiveCheckOut.isBlank()) &amp;&amp; context != null) {</span>
<span class="nc" id="L144">            effectiveCheckOut = context.checkOutDate();</span>
        }

<span class="fc" id="L147">        List&lt;HotelDetailsDTO&gt; hotelDetails = hotelService.getHotelById(hotelId, adults, effectiveCheckIn, effectiveCheckOut);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (hotelDetails == null) {</span>
<span class="nc" id="L149">            hotelDetails = List.of();</span>
        }
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        HotelDTO hotel = hotelDetails.isEmpty() ? null : hotelDetails.get(0).hotel();</span>
<span class="fc" id="L152">        List&lt;HotelOfferDTO&gt; offers = hotelDetails.stream()</span>
<span class="fc" id="L153">            .map(HotelDetailsDTO::offer)</span>
<span class="fc" id="L154">            .filter(Objects::nonNull)</span>
<span class="fc" id="L155">            .toList();</span>

<span class="fc" id="L157">        Integer currentPage = (Integer) session.getAttribute(HotelEnum.CURRENT_PAGE.getValue());</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (currentPage == null) {</span>
<span class="nc" id="L159">            currentPage = 0;</span>
        }

<span class="fc" id="L162">        model.addAttribute(&quot;hotel&quot;, hotel);</span>
<span class="fc" id="L163">        model.addAttribute(&quot;offers&quot;, offers);</span>
<span class="fc" id="L164">        model.addAttribute(&quot;adults&quot;, adults);</span>
<span class="fc" id="L165">        model.addAttribute(HotelEnum.CURRENT_PAGE.getValue(), currentPage);</span>
<span class="fc" id="L166">        model.addAttribute(&quot;hotelId&quot;, hotelId);</span>
<span class="fc" id="L167">        model.addAttribute(&quot;checkInDate&quot;, effectiveCheckIn);</span>
<span class="fc" id="L168">        model.addAttribute(&quot;checkOutDate&quot;, effectiveCheckOut);</span>

<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if (context != null) {</span>
<span class="fc" id="L171">            model.addAttribute(&quot;cityName&quot;, context.destination());</span>
<span class="fc" id="L172">            model.addAttribute(&quot;countryCode&quot;, context.countryCode());</span>
        }

<span class="fc" id="L175">        return &quot;hotel_details&quot;;</span>
    }

    private int populateHotelsModel(
            Model model,
            List&lt;HotelDTO&gt; hotels,
            int requestedPage,
            HotelSearchContext context
    ) {
<span class="fc" id="L184">        var pagination = new Pagination&lt;&gt;(hotels, requestedPage,</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">                context != null ? context.pageSize() : DEFAULT_PAGE_SIZE);</span>

<span class="fc" id="L187">        var availability = availabilityService.loadAvailability(</span>
<span class="fc" id="L188">                pagination.items(), </span>
                context
        );

<span class="fc" id="L192">        model.addAttribute(HotelEnum.HOTELS_DATA.getValue(), pagination.items());</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        model.addAttribute(&quot;totalHotels&quot;, hotels == null ? 0 : hotels.size());</span>
<span class="fc" id="L194">        model.addAttribute(HotelEnum.CURRENT_PAGE.getValue(), pagination.page());</span>
<span class="fc" id="L195">        model.addAttribute(HotelEnum.TOTAL_PAGES.getValue(), pagination.totalPages());</span>
<span class="fc" id="L196">        model.addAttribute(HotelEnum.PAGE_SIZE.getValue(), pagination.pageSize());</span>
<span class="fc" id="L197">        model.addAttribute(&quot;availability&quot;, availability);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">        model.addAttribute(&quot;availabilityHasDates&quot;,</span>
<span class="pc bpc" id="L199" title="2 of 4 branches missed.">                context != null &amp;&amp; context.checkInDate() != null &amp;&amp; context.checkOutDate() != null</span>
        );

<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (context != null) {</span>
<span class="fc" id="L203">            model.addAttribute(&quot;request&quot;, context);</span>
        }

<span class="fc" id="L206">        return pagination.page();</span>
    }


    private List&lt;HotelDTO&gt; getHotelsFromSession(HttpSession session) {
<span class="fc" id="L211">        Object attribute = session.getAttribute(HotelEnum.HOTELS_DATA.getValue());</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (attribute instanceof List) {</span>
<span class="fc" id="L213">            List&lt;?&gt; raw = (List&lt;?&gt;) attribute;</span>
<span class="fc" id="L214">            return raw.stream()</span>
<span class="fc" id="L215">                    .filter(Objects::nonNull)</span>
<span class="fc" id="L216">                    .filter(HotelDTO.class::isInstance)</span>
<span class="fc" id="L217">                    .map(HotelDTO.class::cast)</span>
<span class="fc" id="L218">                    .toList();</span>
        }
<span class="nc" id="L220">        return List.of();</span>
    }

    private int normalizePageSize(int size) {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        return size &lt;= 0 ? DEFAULT_PAGE_SIZE : size;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>